<?php
// haetaan db:sta 

//connect to a database named "template1" on the host "localhost" with a username and password
// portti voi muuttua
// muodostetaan yhteys  tietokantaan template1

// independent variables
$dbHost = "localhost";
$dbPort = 5432;
$dbName = "noa";
$dbUser = "noa";
$dbPassword = "123";

$conn = "host=$dbHost port=$dbPort dbname=$dbName user=$dbUser password=$dbPassword";

// you can store the username and password to $_SESSION variable

$dbconn = pg_connect($conn);

if(!$dbconn) {
    echo "An error occurred - Henruuuuu!\n";
    exit;
}

// haetaan muuttujien arvot lomakkeelta
// We do not save passwords in plain text


$username = $_POST['username'];
$passhash_md5 = md5($_POST['password']);
$email = $_POST['email'];

if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
     // palataan paasivulle
    header("Location: index.php");
    die("Wrong email-address");
}


// haetaan muuttujien arvot db:sta ja lomakkeelta
$sql = "SELECT username, passhash_md5, email 
    FROM users
    WHERE username = $_POST['username']       
    AND email = $_POST['email']
    AND passhash_md5 = $_POST['password'];

$result = pg_query($dbconn, $sql);
if(!$result) {
    echo "An error occurred - Henruuuuuuu!\n";
    exit;
}

if ( $login_cookie_original !== $login_cookie )
{

// TODO tahan insert into querit
//      tyyliin
// INSERT INTO into VALUES ( $username, $password, $email )

}
else {
    // palataan paasivulle
    header("Location: index.php");
    die("logged in");
}

pg_close($dbconn);
?>
